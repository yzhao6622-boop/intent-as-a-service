# 手动部署步骤（如果脚本无法运行）

如果 PowerShell 脚本无法运行，可以按照以下步骤手动部署：

## 步骤1：安装 Node.js

1. 访问 https://nodejs.org/
2. 下载 Windows 安装包（LTS 版本）
3. 安装并验证：
   ```powershell
   node --version
   npm --version
   ```

## 步骤2：进入项目目录

```powershell
cd D:\intent-as-a-service
# 或您的项目路径
```

## 步骤3：安装后端依赖

```powershell
npm install
```

## 步骤4：安装前端依赖

```powershell
cd client
npm install
cd ..
```

## 步骤5：配置环境变量

```powershell
# 复制示例文件
copy env.example .env

# 编辑 .env 文件
notepad .env
```

在 `.env` 文件中填入：
```env
PORT=3002
NODE_ENV=production
JWT_SECRET=生成一个随机字符串（至少32字符）
ARK_API_KEY=你的火山方舟API密钥
ARK_MODEL_ID=你的模型ID
ARK_API_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
DB_PATH=./data/intent.db
```

## 步骤6：创建数据目录

```powershell
mkdir data
```

## 步骤7：初始化数据库

```powershell
npm run migrate
```

## 步骤8：构建后端

```powershell
npm run build:server
```

## 步骤9：构建前端

```powershell
npm run build:client
```

## 步骤10：安装 PM2（可选，推荐）

```powershell
npm install -g pm2
```

## 步骤11：启动应用

### 方式1：使用 PM2（推荐）

```powershell
pm2 start ecosystem.config.js
pm2 save
```

### 方式2：直接运行

```powershell
npm start
```

## 步骤12：验证部署

1. 打开浏览器访问：`http://localhost:3002/health`
2. 应该看到：`{"status":"ok","message":"Intent-as-a-Service API 运行中"}`

## 步骤13：配置防火墙

### Windows 防火墙

1. 打开"Windows Defender 防火墙"
2. 高级设置 → 入站规则 → 新建规则
3. 端口 → TCP → 输入 3002 和 5173
4. 允许连接

### 阿里云安全组

1. 登录阿里云控制台
2. ECS → 安全组 → 配置规则
3. 添加入站规则：
   - 端口：3002（后端）
   - 端口：5173（前端）
   - 协议：TCP
   - 授权对象：0.0.0.0/0

## 步骤14：访问应用

- 后端：`http://your-server-ip:3002`
- 前端：`http://your-server-ip:5173`

---

## 常用命令

### PM2 管理

```powershell
pm2 status              # 查看状态
pm2 logs                # 查看日志
pm2 restart intent-api  # 重启
pm2 stop intent-api     # 停止
```

### 更新应用

```powershell
git pull
npm install
cd client && npm install && cd ..
npm run build
pm2 restart intent-api
```

---

## 遇到问题？

1. **端口被占用**
   ```powershell
   netstat -ano | findstr :3002
   taskkill /F /PID <进程ID>
   ```

2. **查看日志**
   ```powershell
   pm2 logs
   ```

3. **检查环境变量**
   ```powershell
   node check-env.js
   ```
