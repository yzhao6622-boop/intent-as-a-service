# 远程访问问题排查指南

如果PM2已启动但无法远程访问，请按以下步骤排查：

## 🔍 问题诊断

### 步骤1：运行检查工具

```bash
检查远程访问.bat
```

这个工具会检查：
- 服务器IP地址
- 端口监听状态
- 防火墙规则
- PM2服务状态

### 步骤2：检查服务监听地址

**问题**：服务器可能只监听 `localhost`，无法从外部访问。

**解决**：确保服务器监听 `0.0.0.0`

#### 后端服务器

检查 `src/server.ts` 第75行，应该是：

```typescript
server = app.listen(PORT, '0.0.0.0', () => {
  // ...
});
```

**如果修改了代码，需要重新构建：**

```bash
npm run build:server
pm2 restart intent-api
```

#### 前端服务器

检查 `client/vite.config.ts`，应该包含：

```typescript
server: {
  host: '0.0.0.0', // 允许外部访问
  port: 5173,
  // ...
}
```

**如果修改了配置，需要重启前端：**

```bash
pm2 restart intent-frontend
```

## 🔥 配置防火墙

### Windows防火墙

#### 方法1：使用脚本（推荐）

以管理员身份运行：

```bash
配置防火墙.bat
```

#### 方法2：手动配置

1. 打开"Windows Defender 防火墙"
2. 点击"高级设置"
3. 选择"入站规则" → "新建规则"
4. 选择"端口" → "下一步"
5. 选择"TCP"，输入端口 `3002` → "下一步"
6. 选择"允许连接" → "下一步"
7. 全部勾选（域、专用、公用）→ "下一步"
8. 名称：`Intent API Backend` → "完成"

重复上述步骤，为端口 `5173` 创建规则（名称：`Intent Frontend`）。

### 阿里云安全组

1. 登录阿里云控制台
2. 进入 ECS → 实例 → 选择您的服务器
3. 点击"安全组" → "配置规则"
4. 点击"添加安全组规则"
5. 配置后端端口：
   - **规则方向**：入方向
   - **授权策略**：允许
   - **协议类型**：自定义TCP
   - **端口范围**：3002/3002
   - **授权对象**：0.0.0.0/0（允许所有IP，或指定IP）
   - **描述**：Intent API Backend
6. 点击"保存"
7. 重复步骤5-6，为端口 `5173` 创建规则（描述：Intent Frontend）

## 🧪 测试访问

### 本地测试

在服务器上测试：

```powershell
# 测试后端
Invoke-WebRequest -Uri "http://localhost:3002/health"

# 测试前端
Invoke-WebRequest -Uri "http://localhost:5173"
```

如果本地可以访问，说明服务正常，问题在防火墙或安全组。

### 远程测试

从其他电脑测试：

```bash
# 测试后端（替换为您的服务器IP）
curl http://your-server-ip:3002/health

# 或在浏览器访问
http://your-server-ip:3002/health
http://your-server-ip:5173
```

## 📋 检查清单

- [ ] 服务器监听 `0.0.0.0` 而不是 `localhost`
- [ ] 后端已重新构建并重启
- [ ] 前端配置已更新并重启
- [ ] Windows防火墙已配置（端口 3002, 5173）
- [ ] 阿里云安全组已配置（端口 3002, 5173）
- [ ] 本地可以访问服务
- [ ] 服务器有公网IP
- [ ] 端口未被其他程序占用

## 🆘 常见问题

### Q1: 本地可以访问，远程不行？

**A:** 这是典型的防火墙/安全组问题：
1. 检查Windows防火墙规则
2. 检查阿里云安全组配置
3. 确认服务器有公网IP

### Q2: 端口显示监听但无法访问？

**A:** 检查监听地址：
```bash
netstat -ano | findstr :3002
```

如果显示 `0.0.0.0:3002` 或 `:::3002`，说明监听正确。
如果显示 `127.0.0.1:3002`，说明只监听本地，需要修改代码。

### Q3: 防火墙已配置但仍无法访问？

**A:** 检查：
1. 防火墙规则是否启用（状态应该是"已启用"）
2. 安全组规则是否保存成功
3. 服务器是否在公网（不是内网IP）
4. 是否有其他防火墙软件（如第三方安全软件）

### Q4: PM2显示online但端口未监听？

**A:** 检查PM2日志：
```bash
pm2 logs intent-api
pm2 logs intent-frontend
```

查看是否有启动错误。

### Q5: 如何确认服务器IP？

**A:** 在服务器上运行：
```powershell
# 查看所有IP
ipconfig

# 或查看公网IP（如果配置了）
curl ifconfig.me
```

## 🔧 快速修复步骤

1. **修改代码监听地址**（如果还没改）
   ```bash
   # 已自动修改 src/server.ts 和 client/vite.config.ts
   ```

2. **重新构建后端**
   ```bash
   npm run build:server
   ```

3. **配置防火墙**
   ```bash
   # 以管理员身份运行
   配置防火墙.bat
   ```

4. **配置阿里云安全组**
   - 在控制台添加端口 3002 和 5173 的入站规则

5. **重启服务**
   ```bash
   pm2 restart all
   ```

6. **测试访问**
   ```bash
   # 本地测试
   curl http://localhost:3002/health
   
   # 远程测试（替换IP）
   curl http://your-server-ip:3002/health
   ```

## 📞 需要帮助？

如果以上步骤都完成但仍无法访问，请提供：
1. `检查远程访问.bat` 的输出结果
2. PM2日志：`pm2 logs`
3. 防火墙规则列表
4. 安全组配置截图
