# 项目更新指南

在服务器上更新项目非常简单，提供了多种更新方式。

## 🚀 快速更新（推荐）

### 方法1: 使用批处理脚本（最简单）

双击运行：
```
更新项目.bat
```

或者使用快速启动：
```
快速更新.bat
```

### 方法2: 使用 PowerShell 脚本（功能更强大）

```powershell
powershell.exe -ExecutionPolicy Bypass -File .\更新项目.ps1
```

## 📋 更新脚本会自动执行以下步骤

1. **拉取最新代码**（如果使用 Git）
   - 自动执行 `git pull`
   - 如果 Git 未安装，会跳过此步骤

2. **更新后端依赖**
   - 执行 `npm install`
   - 安装或更新所有后端依赖包

3. **更新前端依赖**
   - 进入 `client` 目录
   - 执行 `npm install`
   - 安装或更新所有前端依赖包

4. **重新构建后端**
   - 执行 `npm run build:server`
   - 编译 TypeScript 代码

5. **重启 PM2 服务**
   - 自动重启所有服务（后端 + 前端）
   - 如果重启失败，会尝试重新启动

6. **检查服务状态**
   - 显示 PM2 服务状态
   - 确认服务是否正常运行

7. **保存 PM2 配置**
   - 保存当前配置，确保开机自启

## 🔧 手动更新步骤

如果自动脚本出现问题，可以手动执行：

```bash
# 1. 拉取最新代码（如果使用 Git）
git pull

# 2. 更新后端依赖
npm install

# 3. 更新前端依赖
cd client
npm install
cd ..

# 4. 重新构建后端
npm run build:server

# 5. 重启服务
pm2 restart all

# 6. 检查状态
pm2 status

# 7. 查看日志（如果有问题）
pm2 logs
```

## ⚠️ 注意事项

### 1. 环境变量文件（.env）

更新脚本**不会覆盖**你的 `.env` 文件，因为它在 `.gitignore` 中。

如果更新后需要更新环境变量：
- 手动编辑 `.env` 文件
- 或从 `env.example` 复制并修改

### 2. 数据库文件

数据库文件（`data/intent.db`）**不会被覆盖**，数据会保留。

### 3. 服务中断时间

更新过程中服务会短暂中断（通常 10-30 秒）：
- 依赖更新：5-10 秒
- 代码构建：5-10 秒
- 服务重启：2-5 秒

### 4. 如果更新失败

如果更新过程中出现错误：

1. **查看详细错误信息**
   ```bash
   pm2 logs
   ```

2. **检查服务状态**
   ```bash
   pm2 status
   ```

3. **手动重启服务**
   ```bash
   pm2 restart all
   ```

4. **如果服务无法启动**
   ```bash
   pm2 delete all
   pm2 start ecosystem.config.js
   ```

## 🔄 更新频率建议

- **开发环境**：每次代码推送后更新
- **生产环境**：建议在低峰期更新（如凌晨）
- **紧急修复**：可随时更新，服务会自动重启

## 📝 更新日志

建议在更新后记录：
- 更新日期和时间
- 更新的内容（Git commit 信息）
- 是否有问题或异常

## 🆘 常见问题

### Q: 更新后服务无法启动？

**A:** 检查以下几点：
1. 查看 PM2 日志：`pm2 logs`
2. 检查端口是否被占用
3. 检查 `.env` 文件配置是否正确
4. 检查依赖是否安装完整：`npm install`

### Q: Git pull 失败？

**A:** 可能原因：
1. 本地有未提交的更改（需要先提交或暂存）
2. 网络问题（检查网络连接）
3. 权限问题（检查 Git 权限）

可以跳过 Git pull，直接更新依赖和重启服务。

### Q: 更新后前端无法访问？

**A:** 检查：
1. 前端服务是否运行：`pm2 status`
2. 查看前端日志：`pm2 logs intent-frontend`
3. 检查端口 5173 是否被占用
4. 检查防火墙和安全组设置

### Q: 如何回滚到之前的版本？

**A:** 如果使用 Git：
```bash
# 查看提交历史
git log

# 回滚到指定版本
git checkout <commit-hash>

# 然后重新构建和重启
npm run build:server
pm2 restart all
```

## 💡 最佳实践

1. **更新前备份**
   - 备份 `.env` 文件
   - 备份数据库文件（`data/intent.db`）

2. **测试环境先更新**
   - 如果有测试环境，先在测试环境更新
   - 确认无误后再更新生产环境

3. **监控更新过程**
   - 更新时保持终端窗口打开
   - 观察是否有错误信息

4. **更新后验证**
   - 访问前端页面，确认功能正常
   - 测试关键功能（登录、创建意图等）
   - 检查 API 是否正常响应
